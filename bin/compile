#!/bin/bash

echo ""
echo "-----> Installing ACT Heroku Buildpack ..."
echo ""

BUILD_DIR=$1
ACT_VERSION=v0.2.26
ACT_FILE_NAME=act_Linux_arm64.tar.gz
DOWNLOAD_LINK=https://github.com/nektos/act/releases/download/$ACT_VERSION/$ACT_FILE_NAME

INSTALL_DIR=$BUILD_DIR/vendor/act/
ACT_DIR=${HOME}/vendor/act

mkdir -p $INSTALL_DIR
code=$(curl "$DOWNLOAD_LINK" -L --silent --fail --retry 5 --retry-max-time 15 -o ./$ACT_FILE_NAME --write-out "%{http_code}")

if [ "$code" != "200" ]; then
  echo "-----> Failed to download act binary ..."
  echo "       Error: $code" && exit 1
fi

tar -xf "./$ACT_FILE_NAME" --strip-components=1

echo "-----> Building Runtime Environment for ACT ..."
echo ""
PROFILE_PATH="$BUILD_DIR/.profile.d/act.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:${HOME}/.heroku/vendor"' >> $PROFILE_PATH

echo "-----> Successfully Installed ACT Buildpack !!"
echo ""
